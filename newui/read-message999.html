<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>myMessage - light-grade & encrypted data storage</title>
	<link rel="icon" type="image/png" sizes="32x32" href="images/favicon.png">
	<link rel="stylesheet" href="css/bootstrap.css">
	<link rel="stylesheet" href="css/main.css">
	<!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" defer></script> -->
	<script src="./js/jquery-3.3.1.min.js"></script>
	<script>window.jQuery || document.write('<script src="js/jquery-3.3.1.min.js" defer><\/script>')</script>
	<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous" defer></script>
	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js" integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI" crossorigin="anonymous" defer></script>
	<script src="js/jquery.main.js" defer></script>
	<script src="js/zilliqa.min.js"></script>
	<script src="js/aes.js"></script>
	<script src="js/md5.js"></script>
</head>
<body>
	<div id="wrapper">
		<div class="wrapper-holder">
			<header class="header">
				<div class="container">
					<div class="header-holder">
						<strong class="logo">
							<a href="/"><img src="images/logo.svg" alt="My Message"></a>
						</strong>
						<nav class="navbar navbar-expand-lg navbar-light">
							<button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navigation-collapse" aria-controls="navigation-collapse" aria-expanded="false" aria-label="Toggle navigation">
								<span class="navbar-toggler-icon"></span>
							</button>
							<div class="collapse navbar-collapse" id="navigation-collapse">
								<div class="nav-area">
									<ul class="navbar-nav">
										<li class="nav-item">
											<a class="nav-link" href="#">Home</a>
										</li>
										<li class="nav-item active">
											<a class="nav-link" href="#">Send Message</a>
										</li>
										<li class="nav-item">
											<a class="nav-link" href="#">Read Message</a>
										</li>
										<li class="nav-item">
											<a class="nav-link" href="#">Message Viewer</a>
										</li>
										<li class="nav-item">
											<a class="nav-link" href="#">Search</a>
										</li>
									</ul>
									<div class="header-select">
										<a href="#" class="select-opener">
											<span class="select-opener-text">
												<span class="select-image">
													<img src="images/zilliqa.svg" width="15" height="21" alt="zilliqa">
												</span>
												<span class="select-text">Zilliqa</span>
											</span>
										</a>
										<div class="header-select-dropdown">
											<ul class="select-dropdown-list list-unstyled">
												<li>
													<a href="#" class="select-dropdown-link">
														<span class="select-opener-text">
															<span class="select-image">
																<img src="images/binance.svg" width="20" height="20" alt="Binance">
															</span>
															<span class="select-text">Binance Smart Chain</span>
														</span>
													</a>
												</li>
												<li>
													<a href="#" class="select-dropdown-link">
														<span class="select-opener-text">
															<span class="select-image">
																<img src="images/avax.svg" width="20" height="20" alt="Avalanche">
															</span>
															<span class="select-text">Avalanche</span>
														</span>
													</a>
												</li>
												<li class="active">
													<a href="#" class="select-dropdown-link">
														<span class="select-opener-text">
															<span class="select-image">
																<img src="images/zilliqa.svg" width="15" height="21" alt="zilliqa">
															</span>
															<span class="select-text">Zilliqa</span>
														</span>
													</a>
												</li>
											</ul>
										</div>
									</div>
									<span class="btn-wrap">
										<a href="#" class="btn btn-outline-primary">
											<span class="btn-text">disconnect</span>
										</a>
									</span>
								</div>
							</div>
						</nav>
					</div>
				</div>
			</header>
			<main class="main">
				<div class="message-info-section">
					<div class="container">
						<div class="heading-area">
							<h1 class="h4">Read Message</h1>
							<p>Read message stored at blockchain,given a TxID.</p>
						</div>
						<div class="row message-info-row sub-read-message">
							<div class="col-12">
								<div class="txid-field-area">
									<div class="txid-field">
										<label>TXID Message</label>
										<input type="text" class="form-control" placeholder=""  id="searchtxid">
									</div>
									<button type="submit" class="btn btn-primary" id="sendtxid" onclick="sendtxid()">SEND</button>
								</div>
								<div class="txid-info-area">
									<div class="row">
										<div class="col-12 col-md-6">
											<div class="txid-info-block">
												<span class="text" id="txid">TXid:<br> 0x5f25a9caf30df3822ee5a9a26098dea60b368bcd0209e32e9d0b4beca79d447b</span>
												<span class="text" id="senderaddress">Sender Address: zil12hn8w329rjyny24rpcs6kfh6k9pc8c6s3cvc9x</span>
												<span class="text" id="blocknum">Blocknum: 3356544</span>
											</div>
										</div>
										<div class="col-12 col-md-6">
											<div class="col-block">
												<div class="block-widget">
													<div class="block-heading">
														<p>If message is encrypted, you can decrypt by entering secret key below.</p>
													</div>
													<div class="form-group">
														<div class="select-holder">
															<span class="select-label">Font : </span>
															<select id="size">
																<option>2px</option>
																<option>4px</option>
																<option>6px</option>
																<option>8px</option>
																<option>10px</option>
																<option>12px</option>
																<option>14px</option>
																<option>16px</option>
																<option>18px</option>
																<option>20px</option>
															</select>
														</div>
													</div>
													<div class="form-group">
														<textarea class="form-control" placeholder="" id="comment"></textarea>
													</div>
													<div class="form-group">
														<div class="checkbox-area">
															<label class="checkbox-label">
																<input type="checkbox" id="encryptmessage">
																<span class="checkbox-text"><i class="icon"></i> Decrypt Message</span>
															</label>
														</div>
													</div>
													<div class="form-group" id="encryptsection">
														<label class="label-field-text">Enter Your Secret Key</label>
														<input type="text" class="form-control" placeholder="" id="secretkey">
													</div>
												</div>
											</div>
											<ul class="submit-btns-list list-unstyled">
												<li><a href="#" id="decryptid" class="btn btn-primary" onclick="decryptmessage()">Decrypt Message</a></li>
												<li><a href="#" id="filedownloadid" class="btn btn-primary" onclick="downloadattachment()">File Download</a></li>
											</ul>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</main>
		</div>
	</div>
	<script>
		var animatespinner='<i class="fas fa-spinner fa-spin fa-2x"></i>'; 

		var oripermanentmessage="";
		var  flagdigit1=0;
		var  flagdigit2=0;
		var  flagdigit3=0;
		txid = window.location.search.split('=')[1];
		$(document).ready(() => {
			console.log('asfasdfsad', txid, Zilliqa)
			readmsgfromblockhain(txid)
		})
		async function readmsgfromblockhain(txid){
			document.getElementById("comment").value="Loading...";
			zilliqa = new Zilliqa.Zilliqa('https://dev-api.zilliqa.com');
			//zilliqa =await new Zilliqa.Zilliqa("https://api.zilliqa.com/");
			
			//txid="d38604292084ae44cd043125f79a9d02ddf781bef90499d70cfbadc60082353a";
			console.log(txid);
			txn = await zilliqa.blockchain.getTransaction(txid);
			msg=txn.receipt.event_logs[0].params[0].value;
			
			
			oripermanentmessage=msg;
			
			//                         01234567 
			// read the flags which is ##122#54  the first 8 bytes should be the flags
			flagstr=msg.substring(0,8);
			flagdigit1= flagstr.charAt(2);
			flagdigit2= flagstr.charAt(3);	 
			flagdigit3= flagstr.charAt(4);
			
			
			console.log("flagstr=", flagstr);
			// document.getElementById("replymessageid").disabled = false;
			if (flagdigit2==2) // content decrypted
				document.getElementById("decryptid").disabled = false;
			if (flagdigit3!=0) // got file attached
				document.getElementById("filedownloadid").disabled = false;

			numofrow=msg.split(/\r\n|\r|\n/).length;
			
			if (numofrow<5) numofrow=5;
			
			document.getElementById("comment").rows = numofrow;
			
			msg=msg.substring(8);
			msg = msg.replace("@@-----@@", "");
			msg = msg.replace("@@-@@@-@@", "");
			
			document.getElementById("comment").value=msg;
			console.log(msg);	
			console.log(txn.senderAddress.toLowerCase());
			senderAddr=Zilliqa.toBech32Address(txn.senderAddress.toLowerCase());	
			console.log(txn.toAddr.toLowerCase());
			contractAddr=Zilliqa.toBech32Address(txn.toAddr.toLowerCase());	 
			blocknum=txn.receipt.epoch_num;
			
			document.getElementById("blocknum").innerHTML="Blocknum: "+blocknum;
			document.getElementById("txid").innerHTML="TXid: 0x"+txid;
			document.getElementById("senderaddress").innerHTML="Sender Address: "+senderAddr;

		//zil1rh4363klwrw6cnmjkguetsh2yx057dqmrr8ufd   senderAddr in zil	 
			//document.getElementById("contractaddress").innerHTML="Contract Address: "+contractAddr; 
			//zil1644y20t8ksj5zm73krgasrw4dnhew020ld0q4y   contract address
		}

		async function decryptmessage() {
			content=oripermanentmessage; ;
			console.log("showing content=", content, CryptoJS);
			endofheader="@@-----@@";
			secretkey=document.getElementById("secretkey").value;
			var decrypted="";
			// attempt to find
			if (content.search(endofheader)==-1)
			{
						//console.log("not found header");
						// no header
						// attempt to decrypt nowrap
						//decrypted = CryptoJS.AES.decrypt(content, secretkey);
						//document.getElementById("comment").value=decrypted;
						
						content=content.substring(8);
						endofcontent="@@-@@@-@@";
						nextindex=content.search(endofcontent);
						
						if (nextindex!=-1)
							content=content.substr(0,nextindex);
						
						
						encryptedtext = content.replace(/(\r\n|\n|\r)/gm, "");
						
						
						bytes = CryptoJS.AES.decrypt(encryptedtext, secretkey);
						decrypted = bytes.toString(CryptoJS.enc.Utf8);		 
						document.getElementById("comment").value= decrypted;		 
				
				
				
				
			}
			else // found header, need to seperate header from encrypted text
			{
					//console.log("found header");

					//endofheader="\r\n@@-----@@\r\n";
					
					
					endofcontent="@@-@@@-@@";
					
					endcontentindex=content.search(endofcontent);
					console.log("endcontentindex=",endcontentindex);

					num= content.search(endofheader);
					// document.getElementById("demo1").innerHTML = str;
					// document.getElementById("demo").innerHTML = num;
					//var res = str.substr(1, 4);
					removelen=num+endofheader.length;

					k=content.length-removelen;
					remainlen=content.length-k;


					headerstr=content.substr(0,remainlen);
					
					headerstr=headerstr.substring(8);
					console.log("header...");
					console.log(headerstr);

					encryptedtext=content.substring(removelen); // removed the header
					
					nextindex=encryptedtext.search(endofcontent);
					
					console.log("nextindex=",nextindex);
					
					if (nextindex!=-1)
						encryptedtext=encryptedtext.substr(0,nextindex);
					
					console.log("encrypt-=",encryptedtext);
					encryptedtext = encryptedtext.replace(/(\r\n|\n|\r)/gm, "");
					
					
					console.log("encryptedtext=",encryptedtext);
					bytes = CryptoJS.AES.decrypt(encryptedtext, secretkey);
					decrypted = bytes.toString(CryptoJS.enc.Utf8);	

				headerstr = headerstr.replace("@@-----@@", "");
				headerstr = headerstr.replace("@@-@@@-@@", "");

				document.getElementById("comment").value=headerstr+"\r\n"+decrypted;		
			}
		} 

		function downloadattachment() {

			content=oripermanentmessage;
			console.log("showing content=", content);
			endofheader= "@@-@@@-@@";;
			secretkey=document.getElementById("secretkey").value;
			var decrypted="";
			// attempt to find
			if (content.search(endofheader)==-1)
			{
						console.log("not attachment found!");
						// no header
						// attempt to decrypt nowrap
						//decrypted = CryptoJS.AES.decrypt(content, secretkey);
						//document.getElementById("comment").value=decrypted;
				
				
						encryptedtext = content.replace(/(\r\n|\n|\r)/gm, "");
						bytes = CryptoJS.AES.decrypt(encryptedtext, secretkey);
						decrypted = bytes.toString(CryptoJS.enc.Utf8);		 
						document.getElementById("comment").value=headerstr+decrypted;		 
				
			}
			else // found header, need to seperate header from encrypted text
			{
						//console.log("found header");

						//endofheader="\r\n@@-----@@\r\n";

						num= content.search(endofheader);
						// document.getElementById("demo1").innerHTML = str;
						// document.getElementById("demo").innerHTML = num;
						//var res = str.substr(1, 4);
						removelen=num+endofheader.length;

						k=content.length-removelen;
						remainlen=content.length-k;


						headerstr=content.substr(0,remainlen);
						//console.log("header...");
						//console.log(headerstr);


						encryptedtext=content.substring(removelen);
						
						
						if (flagdigit3==2) // file encrypted
						{
								secretkey=document.getElementById("secretkey").value;
								//console.log(encryptedtext);
								encryptedtext = encryptedtext.replace(/(\r\n|\n|\r)/gm, "");
								bytes = CryptoJS.AES.decrypt(encryptedtext, secretkey);
								decrypted = bytes.toString(CryptoJS.enc.Utf8);		 
								encryptedtext = decrypted;					
							
							
						}
						else // file not encrypted
						{
						
							//console.log(encryptedtext);
							encryptedtext = encryptedtext.replace(/(\r\n|\n|\r)/gm, "");
							
							console.log("attachment:",encryptedtext);					
							
							
						}
						

						
						/// now download the attachment

						
		
						//var file = dataURLtoFile(encryptedtext,'hello22.txt');
						//console.log(file);
						// Download it
						//data:image/png;base64
						
						///find filename   hello.txtdata:image/png...
						/// note it depends on finding data: 
						/// the filename must not have :
						
						endnum=encryptedtext.search("data:");
						var filename=encryptedtext.substr(0,endnum);  // extract filename
						encryptedtext= encryptedtext. substring(endnum); // removed the front filename
						
						//var filename ='abc.txt';
						var link = document.createElement('a');
						link.style.display = 'none';
						link.setAttribute('target', '_blank');
						link.setAttribute('href', encryptedtext);
						link.setAttribute('download', filename);
						document.body.appendChild(link);
						link.click();
						document.body.removeChild(link);
								
			}
			/// detect if there is any file attached	
		}

		$("#size").on("change keyup paste", function(){
    
			size=document.getElementById("size").value; 
			console.log(size);
			if (size.includes('2'))
			{
			document.getElementById("comment").style.fontSize = "2px";
				document.getElementById("comment").rows = "150";
				
				
			}
			if (size.includes('4'))
			{
				document.getElementById("comment").style.fontSize = "4px";
				document.getElementById("comment").rows = "75";		
			}
			if (size.includes('6'))
			{
				document.getElementById("comment").style.fontSize = "6px";
				document.getElementById("comment").rows = "50";			
			}
			if (size.includes('8'))
			{
				document.getElementById("comment").style.fontSize = "8px";
				document.getElementById("comment").rows = "38";			
				
			}
			if (['10px', '12px', '14px', '16px', '18px', '20px'].includes(size))
			{
				document.getElementById("comment").style.fontSize = size;
			//  document.getElementById("comment").rows = "32";			
				
			}
		})
		$("#encryptmessage").on("change keyup paste", function(){
    
			//console.log("Press");
			encryptedchecked=document.getElementById("encryptmessage").checked;
			if (encryptedchecked) {
				//console.log("checked");
				document.getElementById("encryptsection").style.display = "block";
				// document.getElementById("secretkey").style.display = "visible";	 
			} else {
				//console.log("unchecked");
				document.getElementById("encryptsection").style.display = "none";
				// document.getElementById("secretkey").style.display = "hidden";		
			}
		})
		function sendtxid() {
			//$txid=$_GET["txid"] ;
			searchtxid=document.getElementById("searchtxid").value;
			//window.location.replace("https://myzilliqawallet.com/pm/readmessage.php?txid="+searchtxid);
			window.location.replace("read-message.html?txid="+searchtxid);
		}
		$('.select-dropdown-list li').on('click', (e) => {
			console.log('csdsd', e)
			e.preventDefault()
			return false;
		})
	</script>
</body>
</html>
